<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-2"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- Module      :  MacroPass</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- Copyright   :  2004 Malcolm Wallace</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Licence     :  LGPL</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Maintainer  :  Malcolm Wallace &lt;Malcolm.Wallace@cs.york.ac.uk&gt;</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Stability   :  experimental</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Portability :  All</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- Perform a cpp.second-pass, accumulating \#define's and \#undef's,</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- whilst doing symbol replacement and macro expansion.</span><span>
</span><a name="line-13"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.Preprocessor.Cpphs.MacroPass</span><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroPass"><span class="hs-identifier hs-var">macroPass</span></a><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#preDefine"><span class="hs-identifier hs-var">preDefine</span></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#defineMacro"><span class="hs-identifier hs-var">defineMacro</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroPassReturningSymTab"><span class="hs-identifier hs-var">macroPassReturningSymTab</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Preprocessor.Cpphs.HashDefine.html"><span class="hs-identifier">Language.Preprocessor.Cpphs.HashDefine</span></a><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.HashDefine.html#HashDefine"><span class="hs-identifier hs-type">HashDefine</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.HashDefine.html#expandMacro"><span class="hs-identifier hs-var">expandMacro</span></a><span>
</span><a name="line-23"></a><span>                                              </span><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.HashDefine.html#simplifyHashDefines"><span class="hs-identifier hs-var">simplifyHashDefines</span></a><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Preprocessor.Cpphs.Tokenise.html"><span class="hs-identifier">Language.Preprocessor.Cpphs.Tokenise</span></a><span>   </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Tokenise.html#tokenise"><span class="hs-identifier hs-var">tokenise</span></a><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.Tokenise.html#WordStyle"><span class="hs-identifier hs-type">WordStyle</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>                                              </span><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.Tokenise.html#parseMacroCall"><span class="hs-identifier hs-var">parseMacroCall</span></a><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Preprocessor.Cpphs.SymTab.html"><span class="hs-identifier">Language.Preprocessor.Cpphs.SymTab</span></a><span>     </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.SymTab.html#SymTab"><span class="hs-identifier hs-type">SymTab</span></a><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.SymTab.html#lookupST"><span class="hs-identifier hs-var">lookupST</span></a><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.SymTab.html#insertST"><span class="hs-identifier hs-var">insertST</span></a><span>
</span><a name="line-27"></a><span>                                              </span><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.SymTab.html#emptyST"><span class="hs-identifier hs-var">emptyST</span></a><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.SymTab.html#flattenST"><span class="hs-identifier hs-var">flattenST</span></a><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Preprocessor.Cpphs.Position.html"><span class="hs-identifier">Language.Preprocessor.Cpphs.Position</span></a><span>   </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Position.html#Posn"><span class="hs-identifier hs-type">Posn</span></a><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.Position.html#newfile"><span class="hs-identifier hs-var">newfile</span></a><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.Position.html#filename"><span class="hs-identifier hs-var">filename</span></a><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.Position.html#lineno"><span class="hs-identifier hs-var">lineno</span></a><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Language.Preprocessor.Cpphs.Options.html"><span class="hs-identifier">Language.Preprocessor.Cpphs.Options</span></a><span>    </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Options.html#BoolOptions"><span class="hs-identifier hs-type">BoolOptions</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO.Unsafe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeInterleaveIO</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">=&lt;&lt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Time</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getClockTime</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">toCalendarTime</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">formatCalendarTime</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Locale</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">defaultTimeLocale</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-identifier">noPos</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Preprocessor.Cpphs.Position.html#Posn"><span class="hs-identifier hs-type">Posn</span></a><span>
</span><a name="line-36"></a><a name="noPos"><a href="Language.Preprocessor.Cpphs.MacroPass.html#noPos"><span class="hs-identifier">noPos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Preprocessor.Cpphs.Position.html#newfile"><span class="hs-identifier hs-var">newfile</span></a><span> </span><span class="hs-string">&quot;preDefined&quot;</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-comment">-- | Walk through the document, replacing calls of macros with the expanded RHS.</span><span>
</span><a name="line-39"></a><span class="hs-identifier">macroPass</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ Pre-defined symbols and their values</span><span>
</span><a name="line-40"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Preprocessor.Cpphs.Options.html#BoolOptions"><span class="hs-identifier hs-type">BoolOptions</span></a><span>        </span><span class="hs-comment">-- ^ Options that alter processing style</span><span>
</span><a name="line-41"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Position.html#Posn"><span class="hs-identifier hs-type">Posn</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- ^ The input file content</span><span>
</span><a name="line-42"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">String</span><span>          </span><span class="hs-comment">-- ^ The file after processing</span><span>
</span><a name="line-43"></a><a name="macroPass"><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroPass"><span class="hs-identifier">macroPass</span></a></a><span> </span><a name="local-6989586621679049825"><a href="#local-6989586621679049825"><span class="hs-identifier">syms</span></a></a><span> </span><a name="local-6989586621679049826"><a href="#local-6989586621679049826"><span class="hs-identifier">options</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-44"></a><span>    </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679049827"><span class="hs-identifier hs-var">safetail</span></a><span>              </span><span class="hs-comment">-- to remove extra &quot;\n&quot; inserted below</span><span>
</span><a name="line-45"></a><span>         </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">concat</span><span>
</span><a name="line-46"></a><span>         </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#onlyRights"><span class="hs-identifier hs-var">onlyRights</span></a><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pragma</span><span> </span><a href="#local-6989586621679049826"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">layout</span><span> </span><a href="#local-6989586621679049826"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">lang</span><span> </span><a href="#local-6989586621679049826"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>                   </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.MacroPass.html#preDefine"><span class="hs-identifier hs-var">preDefine</span></a><span> </span><a href="#local-6989586621679049826"><span class="hs-identifier hs-var">options</span></a><span> </span><a href="#local-6989586621679049825"><span class="hs-identifier hs-var">syms</span></a><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.Preprocessor.Cpphs.Tokenise.html#tokenise"><span class="hs-identifier hs-var">tokenise</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">stripEol</span><span> </span><a href="#local-6989586621679049826"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">stripC89</span><span> </span><a href="#local-6989586621679049826"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier">ansi</span><span> </span><a href="#local-6989586621679049826"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">lang</span><span> </span><a href="#local-6989586621679049826"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.MacroPass.html#noPos"><span class="hs-identifier hs-var">noPos</span></a><span class="hs-special">,</span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- ensure recognition of &quot;\n#&quot; at start of file</span><span>
</span><a name="line-52"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-53"></a><span>    </span><a name="local-6989586621679049827"><a href="#local-6989586621679049827"><span class="hs-identifier">safetail</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-54"></a><span>    </span><span class="hs-identifier">safetail</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><a name="local-6989586621679049828"><a href="#local-6989586621679049828"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679049828"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-comment">-- | auxiliary</span><span>
</span><a name="line-57"></a><span class="hs-identifier">onlyRights</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679049823"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679049824"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679049824"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-58"></a><a name="onlyRights"><a href="Language.Preprocessor.Cpphs.MacroPass.html#onlyRights"><span class="hs-identifier">onlyRights</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679049829"><a href="#local-6989586621679049829"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">-&gt;</span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679049829"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679049830"><a href="#local-6989586621679049830"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679049830"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">]</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">;</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">-- | Walk through the document, replacing calls of macros with the expanded RHS.</span><span>
</span><a name="line-61"></a><span class="hs-comment">--   Additionally returns the active symbol table after processing.</span><span>
</span><a name="line-62"></a><span class="hs-identifier">macroPassReturningSymTab</span><span>
</span><a name="line-63"></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ Pre-defined symbols and their values</span><span>
</span><a name="line-64"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Preprocessor.Cpphs.Options.html#BoolOptions"><span class="hs-identifier hs-type">BoolOptions</span></a><span>        </span><span class="hs-comment">-- ^ Options that alter processing style</span><span>
</span><a name="line-65"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Position.html#Posn"><span class="hs-identifier hs-type">Posn</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- ^ The input file content</span><span>
</span><a name="line-66"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>                                </span><span class="hs-comment">-- ^ The file and symbol table after processing</span><span>
</span><a name="line-68"></a><a name="macroPassReturningSymTab"><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroPassReturningSymTab"><span class="hs-identifier">macroPassReturningSymTab</span></a></a><span> </span><a name="local-6989586621679049831"><a href="#local-6989586621679049831"><span class="hs-identifier">syms</span></a></a><span> </span><a name="local-6989586621679049832"><a href="#local-6989586621679049832"><span class="hs-identifier">options</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-69"></a><span>    </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679049835"><span class="hs-identifier hs-var">mapFst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679049833"><span class="hs-identifier hs-var">safetail</span></a><span>              </span><span class="hs-comment">-- to remove extra &quot;\n&quot; inserted below</span><span>
</span><a name="line-70"></a><span>                 </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">concat</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>         </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679049834"><span class="hs-identifier hs-var">walk</span></a><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pragma</span><span> </span><a href="#local-6989586621679049832"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">layout</span><span> </span><a href="#local-6989586621679049832"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">lang</span><span> </span><a href="#local-6989586621679049832"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>                   </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.MacroPass.html#preDefine"><span class="hs-identifier hs-var">preDefine</span></a><span> </span><a href="#local-6989586621679049832"><span class="hs-identifier hs-var">options</span></a><span> </span><a href="#local-6989586621679049831"><span class="hs-identifier hs-var">syms</span></a><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.Preprocessor.Cpphs.Tokenise.html#tokenise"><span class="hs-identifier hs-var">tokenise</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">stripEol</span><span> </span><a href="#local-6989586621679049832"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">stripC89</span><span> </span><a href="#local-6989586621679049832"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier">ansi</span><span> </span><a href="#local-6989586621679049832"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">lang</span><span> </span><a href="#local-6989586621679049832"><span class="hs-identifier hs-var">options</span></a><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.MacroPass.html#noPos"><span class="hs-identifier hs-var">noPos</span></a><span class="hs-special">,</span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- ensure recognition of &quot;\n#&quot; at start of file</span><span>
</span><a name="line-77"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-78"></a><span>    </span><a name="local-6989586621679049833"><a href="#local-6989586621679049833"><span class="hs-identifier">safetail</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-79"></a><span>    </span><span class="hs-identifier">safetail</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><a name="local-6989586621679049836"><a href="#local-6989586621679049836"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679049836"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-80"></a><span>    </span><a name="local-6989586621679049834"><a href="#local-6989586621679049834"><span class="hs-identifier">walk</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679049837"><a href="#local-6989586621679049837"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679049838"><a href="#local-6989586621679049838"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679049839"><a href="#local-6989586621679049839"><span class="hs-identifier">xs</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-6989586621679049840"><a href="#local-6989586621679049840"><span class="hs-identifier">foo</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679049834"><span class="hs-identifier hs-var">walk</span></a><span> </span><a href="#local-6989586621679049838"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-81"></a><span>                           </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><a href="#local-6989586621679049837"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679049839"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679049840"><span class="hs-identifier hs-var">foo</span></a><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span>    </span><span class="hs-identifier">walk</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679049841"><a href="#local-6989586621679049841"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">,</span><span> </span><a href="Language.Preprocessor.Cpphs.HashDefine.html#simplifyHashDefines"><span class="hs-identifier hs-var">simplifyHashDefines</span></a><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.SymTab.html#flattenST"><span class="hs-identifier hs-var">flattenST</span></a><span> </span><a href="#local-6989586621679049841"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span>    </span><span class="hs-identifier">walk</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679049842"><a href="#local-6989586621679049842"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679049843"><a href="#local-6989586621679049843"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679049834"><span class="hs-identifier hs-var">walk</span></a><span> </span><a href="#local-6989586621679049843"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-84"></a><span>    </span><a name="local-6989586621679049835"><a href="#local-6989586621679049835"><span class="hs-identifier">mapFst</span></a></a><span> </span><a name="local-6989586621679049844"><a href="#local-6989586621679049844"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679049845"><a href="#local-6989586621679049845"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><a name="local-6989586621679049846"><a href="#local-6989586621679049846"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679049844"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679049845"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679049846"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-comment">-- | Turn command-line definitions (from @-D@) into 'HashDefine's.</span><span>
</span><a name="line-88"></a><span class="hs-identifier">preDefine</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Preprocessor.Cpphs.Options.html#BoolOptions"><span class="hs-identifier hs-type">BoolOptions</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Preprocessor.Cpphs.SymTab.html#SymTab"><span class="hs-identifier hs-type">SymTab</span></a><span> </span><a href="Language.Preprocessor.Cpphs.HashDefine.html#HashDefine"><span class="hs-identifier hs-type">HashDefine</span></a><span>
</span><a name="line-89"></a><a name="preDefine"><a href="Language.Preprocessor.Cpphs.MacroPass.html#preDefine"><span class="hs-identifier">preDefine</span></a></a><span> </span><a name="local-6989586621679049847"><a href="#local-6989586621679049847"><span class="hs-identifier">options</span></a></a><span> </span><a name="local-6989586621679049848"><a href="#local-6989586621679049848"><span class="hs-identifier">defines</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-90"></a><span>    </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.SymTab.html#insertST"><span class="hs-identifier hs-var">insertST</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#defineMacro"><span class="hs-identifier hs-var">defineMacro</span></a><span> </span><a href="#local-6989586621679049847"><span class="hs-identifier hs-var">options</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679049849"><a href="#local-6989586621679049849"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><a name="local-6989586621679049850"><a href="#local-6989586621679049850"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679049849"><span class="hs-identifier hs-var">s</span></a><span class="hs-operator hs-var">++</span><span class="hs-string">&quot; &quot;</span><span class="hs-operator hs-var">++</span><a href="#local-6989586621679049850"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>          </span><a href="Language.Preprocessor.Cpphs.SymTab.html#emptyST"><span class="hs-identifier hs-var">emptyST</span></a><span> </span><a href="#local-6989586621679049848"><span class="hs-identifier hs-var">defines</span></a><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span class="hs-comment">-- | Turn a string representing a macro definition into a 'HashDefine'.</span><span>
</span><a name="line-94"></a><span class="hs-identifier">defineMacro</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.Preprocessor.Cpphs.Options.html#BoolOptions"><span class="hs-identifier hs-type">BoolOptions</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><a href="Language.Preprocessor.Cpphs.HashDefine.html#HashDefine"><span class="hs-identifier hs-type">HashDefine</span></a><span class="hs-special">)</span><span>
</span><a name="line-95"></a><a name="defineMacro"><a href="Language.Preprocessor.Cpphs.MacroPass.html#defineMacro"><span class="hs-identifier">defineMacro</span></a></a><span> </span><a name="local-6989586621679049851"><a href="#local-6989586621679049851"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679049852"><a href="#local-6989586621679049852"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-96"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Tokenise.html#Cmd"><span class="hs-identifier hs-var">Cmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679049853"><a href="#local-6989586621679049853"><span class="hs-identifier">hd</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Preprocessor.Cpphs.Tokenise.html#tokenise"><span class="hs-identifier hs-var">tokenise</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ansi</span><span> </span><a href="#local-6989586621679049851"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">lang</span><span> </span><a href="#local-6989586621679049851"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>                                     </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.MacroPass.html#noPos"><span class="hs-identifier hs-var">noPos</span></a><span class="hs-special">,</span><span class="hs-string">&quot;\n#define &quot;</span><span class="hs-operator hs-var">++</span><a href="#local-6989586621679049852"><span class="hs-identifier hs-var">s</span></a><span class="hs-operator hs-var">++</span><span class="hs-string">&quot;\n&quot;</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-98"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">name</span><span> </span><a href="#local-6989586621679049853"><span class="hs-identifier hs-var">hd</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679049853"><span class="hs-identifier hs-var">hd</span></a><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-comment">-- | Trundle through the document, one word at a time, using the WordStyle</span><span>
</span><a name="line-102"></a><span class="hs-comment">--   classification introduced by 'tokenise' to decide whether to expand a</span><span>
</span><a name="line-103"></a><span class="hs-comment">--   word or macro.  Encountering a \#define or \#undef causes that symbol to</span><span>
</span><a name="line-104"></a><span class="hs-comment">--   be overwritten in the symbol table.  Any other remaining cpp directives</span><span>
</span><a name="line-105"></a><span class="hs-comment">--   are discarded and replaced with blanks, except for \#line markers.</span><span>
</span><a name="line-106"></a><span class="hs-comment">--   All valid identifiers are checked for the presence of a definition</span><span>
</span><a name="line-107"></a><span class="hs-comment">--   of that name in the symbol table, and if so, expanded appropriately.</span><span>
</span><a name="line-108"></a><span class="hs-comment">--   (Bool arguments are: keep pragmas?  retain layout?  haskell language?)</span><span>
</span><a name="line-109"></a><span class="hs-comment">--   The result lazily intersperses output text with symbol tables.  Lines</span><span>
</span><a name="line-110"></a><span class="hs-comment">--   are emitted as they are encountered.  A symbol table is emitted after</span><span>
</span><a name="line-111"></a><span class="hs-comment">--   each change to the defined symbols, and always at the end of processing.</span><span>
</span><a name="line-112"></a><span class="hs-identifier">macroProcess</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Preprocessor.Cpphs.SymTab.html#SymTab"><span class="hs-identifier hs-type">SymTab</span></a><span> </span><a href="Language.Preprocessor.Cpphs.HashDefine.html#HashDefine"><span class="hs-identifier hs-type">HashDefine</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Language.Preprocessor.Cpphs.Tokenise.html#WordStyle"><span class="hs-identifier hs-type">WordStyle</span></a><span class="hs-special">]</span><span>
</span><a name="line-113"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.SymTab.html#SymTab"><span class="hs-identifier hs-type">SymTab</span></a><span> </span><a href="Language.Preprocessor.Cpphs.HashDefine.html#HashDefine"><span class="hs-identifier hs-type">HashDefine</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-114"></a><a name="macroProcess"><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier">macroProcess</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679049854"><a href="#local-6989586621679049854"><span class="hs-identifier">st</span></a></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679049854"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">]</span><span>
</span><a name="line-115"></a><span class="hs-identifier">macroProcess</span><span> </span><a name="local-6989586621679049855"><a href="#local-6989586621679049855"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679049856"><a href="#local-6989586621679049856"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621679049857"><a href="#local-6989586621679049857"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679049858"><a href="#local-6989586621679049858"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Tokenise.html#Other"><span class="hs-identifier hs-var">Other</span></a><span> </span><a name="local-6989586621679049859"><a href="#local-6989586621679049859"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679049860"><a href="#local-6989586621679049860"><span class="hs-identifier">ws</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621679049859"><span class="hs-identifier hs-var">x</span></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049855"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679049856"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621679049857"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679049858"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679049860"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-116"></a><span class="hs-identifier">macroProcess</span><span> </span><a name="local-6989586621679049861"><a href="#local-6989586621679049861"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679049862"><a href="#local-6989586621679049862"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621679049863"><a href="#local-6989586621679049863"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679049864"><a href="#local-6989586621679049864"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Tokenise.html#Cmd"><span class="hs-identifier hs-var">Cmd</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679049865"><a href="#local-6989586621679049865"><span class="hs-identifier">ws</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-string">&quot;\n&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049861"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679049862"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621679049863"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679049864"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679049865"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-117"></a><span class="hs-identifier">macroProcess</span><span> </span><a name="local-6989586621679049866"><a href="#local-6989586621679049866"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679049867"><a href="#local-6989586621679049867"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621679049868"><a href="#local-6989586621679049868"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679049869"><a href="#local-6989586621679049869"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Tokenise.html#Cmd"><span class="hs-identifier hs-var">Cmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.HashDefine.html#LineDrop"><span class="hs-identifier hs-var">LineDrop</span></a><span> </span><a name="local-6989586621679049870"><a href="#local-6989586621679049870"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679049871"><a href="#local-6989586621679049871"><span class="hs-identifier">ws</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>                                         </span><span class="hs-glyph">=</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-string">&quot;\n&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-119"></a><span>                                           </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621679049870"><span class="hs-identifier hs-var">x</span></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049866"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679049867"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621679049868"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679049869"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679049871"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-120"></a><span class="hs-identifier">macroProcess</span><span> </span><a name="local-6989586621679049872"><a href="#local-6989586621679049872"><span class="hs-identifier">pragma</span></a></a><span> </span><a name="local-6989586621679049873"><a href="#local-6989586621679049873"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621679049874"><a href="#local-6989586621679049874"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679049875"><a href="#local-6989586621679049875"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Tokenise.html#Cmd"><span class="hs-identifier hs-var">Cmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.HashDefine.html#Pragma"><span class="hs-identifier hs-var">Pragma</span></a><span> </span><a name="local-6989586621679049876"><a href="#local-6989586621679049876"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679049877"><a href="#local-6989586621679049877"><span class="hs-identifier">ws</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679049872"><span class="hs-identifier hs-var">pragma</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-string">&quot;\n&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621679049876"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049872"><span class="hs-identifier hs-var">pragma</span></a><span> </span><a href="#local-6989586621679049873"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621679049874"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679049875"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679049877"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-122"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-string">&quot;\n&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>          </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049872"><span class="hs-identifier hs-var">pragma</span></a><span> </span><a href="#local-6989586621679049873"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621679049874"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621679049875"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679049877"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-123"></a><span class="hs-identifier">macroProcess</span><span> </span><a name="local-6989586621679049878"><a href="#local-6989586621679049878"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679049879"><a href="#local-6989586621679049879"><span class="hs-identifier">layout</span></a></a><span> </span><a name="local-6989586621679049880"><a href="#local-6989586621679049880"><span class="hs-identifier">lang</span></a></a><span> </span><a name="local-6989586621679049881"><a href="#local-6989586621679049881"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Tokenise.html#Cmd"><span class="hs-identifier hs-var">Cmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679049882"><a href="#local-6989586621679049882"><span class="hs-identifier">hd</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679049883"><a href="#local-6989586621679049883"><span class="hs-identifier">ws</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-124"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679049884"><a href="#local-6989586621679049884"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier">linebreaks</span><span> </span><a href="#local-6989586621679049882"><span class="hs-identifier hs-var">hd</span></a><span>
</span><a name="line-125"></a><span>        </span><a name="local-6989586621679049885"><a href="#local-6989586621679049885"><span class="hs-identifier">newST</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.Preprocessor.Cpphs.SymTab.html#insertST"><span class="hs-identifier hs-var">insertST</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">name</span><span> </span><a href="#local-6989586621679049882"><span class="hs-identifier hs-var">hd</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679049882"><span class="hs-identifier hs-var">hd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679049881"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-126"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-127"></a><span>    </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621679049884"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-char">'\n'</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-128"></a><span>    </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emitSymTab"><span class="hs-identifier hs-var">emitSymTab</span></a><span> </span><a href="#local-6989586621679049885"><span class="hs-identifier hs-var">newST</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-129"></a><span>    </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049878"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679049879"><span class="hs-identifier hs-var">layout</span></a><span> </span><a href="#local-6989586621679049880"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621679049885"><span class="hs-identifier hs-var">newST</span></a><span> </span><a href="#local-6989586621679049883"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-130"></a><span class="hs-identifier">macroProcess</span><span> </span><a name="local-6989586621679049886"><a href="#local-6989586621679049886"><span class="hs-identifier">pr</span></a></a><span> </span><a name="local-6989586621679049887"><a href="#local-6989586621679049887"><span class="hs-identifier">layout</span></a></a><span> </span><a name="local-6989586621679049888"><a href="#local-6989586621679049888"><span class="hs-identifier">lang</span></a></a><span> </span><a name="local-6989586621679049889"><a href="#local-6989586621679049889"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Tokenise.html#Ident"><span class="hs-identifier hs-var">Ident</span></a><span> </span><a name="local-6989586621679049890"><a href="#local-6989586621679049890"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679049891"><a href="#local-6989586621679049891"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679049892"><a href="#local-6989586621679049892"><span class="hs-identifier">ws</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-131"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679049891"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-132"></a><span>      </span><span class="hs-string">&quot;__FILE__&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Position.html#filename"><span class="hs-identifier hs-var">filename</span></a><span> </span><a href="#local-6989586621679049890"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049886"><span class="hs-identifier hs-var">pr</span></a><span> </span><a href="#local-6989586621679049887"><span class="hs-identifier hs-var">layout</span></a><span> </span><a href="#local-6989586621679049888"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621679049889"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679049892"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-133"></a><span>      </span><span class="hs-string">&quot;__LINE__&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Position.html#lineno"><span class="hs-identifier hs-var">lineno</span></a><span> </span><a href="#local-6989586621679049890"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049886"><span class="hs-identifier hs-var">pr</span></a><span> </span><a href="#local-6989586621679049887"><span class="hs-identifier hs-var">layout</span></a><span> </span><a href="#local-6989586621679049888"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621679049889"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679049892"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-134"></a><span>      </span><span class="hs-string">&quot;__DATE__&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679049893"><a href="#local-6989586621679049893"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-135"></a><span>                            </span><span class="hs-identifier hs-var">formatCalendarTime</span><span> </span><span class="hs-identifier hs-var">defaultTimeLocale</span><span> </span><span class="hs-string">&quot;\&quot;%d %b %Y\&quot;&quot;</span><span>
</span><a name="line-136"></a><span>                            </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">toCalendarTime</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">getClockTime</span><span>
</span><a name="line-137"></a><span>                       </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621679049893"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049886"><span class="hs-identifier hs-var">pr</span></a><span> </span><a href="#local-6989586621679049887"><span class="hs-identifier hs-var">layout</span></a><span> </span><a href="#local-6989586621679049888"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621679049889"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679049892"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-138"></a><span>      </span><span class="hs-string">&quot;__TIME__&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679049894"><a href="#local-6989586621679049894"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-139"></a><span>                            </span><span class="hs-identifier hs-var">formatCalendarTime</span><span> </span><span class="hs-identifier hs-var">defaultTimeLocale</span><span> </span><span class="hs-string">&quot;\&quot;%H:%M:%S\&quot;&quot;</span><span>
</span><a name="line-140"></a><span>                            </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">toCalendarTime</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">getClockTime</span><span>
</span><a name="line-141"></a><span>                       </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621679049894"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049886"><span class="hs-identifier hs-var">pr</span></a><span> </span><a href="#local-6989586621679049887"><span class="hs-identifier hs-var">layout</span></a><span> </span><a href="#local-6989586621679049888"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621679049889"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679049892"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-142"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-143"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="Language.Preprocessor.Cpphs.SymTab.html#lookupST"><span class="hs-identifier hs-var">lookupST</span></a><span> </span><a href="#local-6989586621679049891"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679049889"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-144"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621679049891"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049886"><span class="hs-identifier hs-var">pr</span></a><span> </span><a href="#local-6989586621679049887"><span class="hs-identifier hs-var">layout</span></a><span> </span><a href="#local-6989586621679049888"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621679049889"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679049892"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-145"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679049895"><a href="#local-6989586621679049895"><span class="hs-identifier">hd</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-146"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679049895"><span class="hs-identifier hs-var">hd</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-147"></a><span>                    </span><a href="Language.Preprocessor.Cpphs.HashDefine.html#AntiDefined"><span class="hs-identifier hs-var">AntiDefined</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">name</span><span class="hs-glyph">=</span><a name="local-6989586621679049896"><a href="#local-6989586621679049896"><span class="hs-identifier">n</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621679049896"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-148"></a><span>                                            </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049886"><span class="hs-identifier hs-var">pr</span></a><span> </span><a href="#local-6989586621679049887"><span class="hs-identifier hs-var">layout</span></a><span> </span><a href="#local-6989586621679049888"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621679049889"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679049892"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-149"></a><span>                    </span><a href="Language.Preprocessor.Cpphs.HashDefine.html#SymbolReplacement"><span class="hs-identifier hs-var">SymbolReplacement</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">replacement</span><span class="hs-glyph">=</span><a name="local-6989586621679049897"><a href="#local-6989586621679049897"><span class="hs-identifier">r</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-150"></a><span>                        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679049898"><a href="#local-6989586621679049898"><span class="hs-identifier">r'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679049887"><span class="hs-identifier hs-var">layout</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679049897"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span class="hs-char">'\n'</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679049897"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-151"></a><span>                        </span><span class="hs-comment">-- one-level expansion only:</span><span>
</span><a name="line-152"></a><span>                        </span><span class="hs-comment">-- emit r' $ macroProcess layout st ws</span><span>
</span><a name="line-153"></a><span>                        </span><span class="hs-comment">-- multi-level expansion:</span><span>
</span><a name="line-154"></a><span>                        </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049886"><span class="hs-identifier hs-var">pr</span></a><span> </span><a href="#local-6989586621679049887"><span class="hs-identifier hs-var">layout</span></a><span> </span><a href="#local-6989586621679049888"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621679049889"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-155"></a><span>                                     </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Tokenise.html#tokenise"><span class="hs-identifier hs-var">tokenise</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621679049888"><span class="hs-identifier hs-var">lang</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679049890"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><a href="#local-6989586621679049898"><span class="hs-identifier hs-var">r'</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-156"></a><span>                                      </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679049892"><span class="hs-identifier hs-var">ws</span></a><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>                    </span><a href="Language.Preprocessor.Cpphs.HashDefine.html#MacroExpansion"><span class="hs-identifier hs-var">MacroExpansion</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-158"></a><span>                        </span><span class="hs-keyword">case</span><span> </span><a href="Language.Preprocessor.Cpphs.Tokenise.html#parseMacroCall"><span class="hs-identifier hs-var">parseMacroCall</span></a><span> </span><a href="#local-6989586621679049890"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679049892"><span class="hs-identifier hs-var">ws</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-159"></a><span>                            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621679049891"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-160"></a><span>                                       </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049886"><span class="hs-identifier hs-var">pr</span></a><span> </span><a href="#local-6989586621679049887"><span class="hs-identifier hs-var">layout</span></a><span> </span><a href="#local-6989586621679049888"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621679049889"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679049892"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-161"></a><span>                            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679049899"><a href="#local-6989586621679049899"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><a name="local-6989586621679049900"><a href="#local-6989586621679049900"><span class="hs-identifier">ws'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-162"></a><span>                                </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679049899"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">arguments</span><span> </span><a href="#local-6989586621679049895"><span class="hs-identifier hs-var">hd</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-163"></a><span>                                     </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621679049891"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049886"><span class="hs-identifier hs-var">pr</span></a><span> </span><a href="#local-6989586621679049887"><span class="hs-identifier hs-var">layout</span></a><span> </span><a href="#local-6989586621679049888"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621679049889"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679049892"><span class="hs-identifier hs-var">ws</span></a><span>
</span><a name="line-164"></a><span>                                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679050313"><a href="#local-6989586621679050313"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span class="hs-operator hs-var">.</span><a href="Language.Preprocessor.Cpphs.MacroPass.html#onlyRights"><span class="hs-identifier hs-var">onlyRights</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>                                                       </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049886"><span class="hs-identifier hs-var">pr</span></a><span> </span><a href="#local-6989586621679049887"><span class="hs-identifier hs-var">layout</span></a><span>
</span><a name="line-166"></a><span>                                                                        </span><a href="#local-6989586621679049888"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621679049889"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>                                                      </span><a href="#local-6989586621679049899"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-168"></a><span>                                        </span><span class="hs-comment">-- one-level expansion only:</span><span>
</span><a name="line-169"></a><span>                                        </span><span class="hs-comment">-- emit (expandMacro hd args' layout) $</span><span>
</span><a name="line-170"></a><span>                                        </span><span class="hs-comment">--         macroProcess layout st ws'</span><span>
</span><a name="line-171"></a><span>                                        </span><span class="hs-comment">-- multi-level expansion:</span><span>
</span><a name="line-172"></a><span>                                        </span><a href="Language.Preprocessor.Cpphs.MacroPass.html#macroProcess"><span class="hs-identifier hs-var">macroProcess</span></a><span> </span><a href="#local-6989586621679049886"><span class="hs-identifier hs-var">pr</span></a><span> </span><a href="#local-6989586621679049887"><span class="hs-identifier hs-var">layout</span></a><span> </span><a href="#local-6989586621679049888"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621679049889"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-173"></a><span>                                            </span><span class="hs-special">(</span><a href="Language.Preprocessor.Cpphs.Tokenise.html#tokenise"><span class="hs-identifier hs-var">tokenise</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621679049888"><span class="hs-identifier hs-var">lang</span></a><span>
</span><a name="line-174"></a><span>                                               </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679049890"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><a href="Language.Preprocessor.Cpphs.HashDefine.html#expandMacro"><span class="hs-identifier hs-var">expandMacro</span></a><span> </span><a href="#local-6989586621679049895"><span class="hs-identifier hs-var">hd</span></a><span> </span><a href="#local-6989586621679050313"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621679049887"><span class="hs-identifier hs-var">layout</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-175"></a><span>                                            </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679049900"><span class="hs-identifier hs-var">ws'</span></a><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span class="hs-comment">-- | Useful helper function.</span><span>
</span><a name="line-178"></a><span class="hs-identifier">emit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679049821"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679049822"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679049821"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679049822"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679049821"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-179"></a><a name="emit"><a href="Language.Preprocessor.Cpphs.MacroPass.html#emit"><span class="hs-identifier">emit</span></a></a><span> </span><a name="local-6989586621679050314"><a href="#local-6989586621679050314"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679050315"><a href="#local-6989586621679050315"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679050335"><a href="#local-6989586621679050335"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unsafeInterleaveIO</span><span> </span><a href="#local-6989586621679050315"><span class="hs-identifier hs-var">io</span></a><span>
</span><a name="line-180"></a><span>               </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679050314"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679050335"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- | Useful helper function.</span><span>
</span><a name="line-182"></a><span class="hs-identifier">emitSymTab</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679049819"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679049819"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679049820"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679049819"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679049820"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-183"></a><a name="emitSymTab"><a href="Language.Preprocessor.Cpphs.MacroPass.html#emitSymTab"><span class="hs-identifier">emitSymTab</span></a></a><span> </span><a name="local-6989586621679050336"><a href="#local-6989586621679050336"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679050337"><a href="#local-6989586621679050337"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679050338"><a href="#local-6989586621679050338"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unsafeInterleaveIO</span><span> </span><a href="#local-6989586621679050337"><span class="hs-identifier hs-var">io</span></a><span>
</span><a name="line-184"></a><span>                     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679050336"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679050338"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-185"></a></pre></body></html>